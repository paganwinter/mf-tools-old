<html>
<head>
</head>

<body>
<div>
  <canvas id="canvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="funds.js"></script>

<script>
function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

async function fetchNav(schemeCode) {
  try {
    let { data } = await axios.get(`https://api.mfapi.in/mf/${schemeCode}`)
    return { data }
  } catch (error) {
    return { error }
  }
}

async function downloadNavs(funds) {
  let calls = funds.map(f => fetchNav(f.code))
  return Promise.all(calls)
}

function subtractYears(dtStr, years) {
  let [y, m, d] = dtStr.split('-')
  y = 1*y - years
  return [y, m, d].join('-')
}

window.onload = async function () {
  console.log(fundsData)
  let targetFunds = fundsData.funds.filter(f => {
    return f.rawCategory === 'Open Ended Schemes(Equity Scheme - Mid Cap Fund)'
      && !f.name.match(/dividend/i)
      && !f.name.match(/direct/i)
  })
  console.log(targetFunds)

  for (let f of targetFunds) {
    console.log(f.name, f.code)
  }

  let navData = await downloadNavs(targetFunds)
  console.log(navData)

  let byDate = {}
  for (let f of navData) {
    let name = f.data.meta.scheme_name
    for (let entry of f.data.data) {
      let nav = parseFloat(entry.nav)
      let dt = entry.date.split('-').reverse().join('-')
      byDate[dt] = byDate[dt] || {}
      byDate[dt][name] = nav
    }
  }
  let dates = Object.keys(byDate).sort()
  console.log(byDate)
  console.log(dates)

  let datasets = []
  for (let f of navData) {
    const name = f.data.meta.scheme_name
    let data = dates.map((dt, i) => {
      let prevDay = subtractYears(dt, 1)
      // console.log(dt, prevDay)
      if (byDate[prevDay] && byDate[prevDay][name]) {
        return (byDate[dt][name] - byDate[prevDay][name]) / byDate[prevDay][name] * 100
      }
    })
    datasets.push({
      label: name,
      data,
      pointRadius: 0,
      fill: false,
      borderColor: getRandomColor(),
      hidden: true,
    })
  }


  let ctx = document.getElementById('canvas').getContext('2d');
  var myLineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets,
    },
    options: {},
  });

}


</script>


</body>
</html>
